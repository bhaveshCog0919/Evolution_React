{"ast":null,"code":"'use strict';\n\nconst MailParser = require('./mail-parser.js');\n\nmodule.exports = (input, options, callback) => {\n  if (!callback && typeof options === 'function') {\n    callback = options;\n    options = false;\n  }\n\n  let promise;\n\n  if (!callback) {\n    promise = new Promise((resolve, reject) => {\n      callback = callbackPromise(resolve, reject);\n    });\n  }\n\n  options = options || {};\n  let keepCidLinks = !!options.keepCidLinks;\n  let mail = {\n    attachments: []\n  };\n  let parser = new MailParser(options);\n  parser.on('error', err => {\n    callback(err);\n  });\n  parser.on('headers', headers => {\n    mail.headers = headers;\n    mail.headerLines = parser.headerLines;\n  });\n  let reading = false;\n\n  let reader = () => {\n    reading = true;\n    let data = parser.read();\n\n    if (data === null) {\n      reading = false;\n      return;\n    }\n\n    if (data.type === 'text') {\n      Object.keys(data).forEach(key => {\n        if (['text', 'html', 'textAsHtml'].includes(key)) {\n          mail[key] = data[key];\n        }\n      });\n    }\n\n    if (data.type === 'attachment') {\n      mail.attachments.push(data);\n      let chunks = [];\n      let chunklen = 0;\n      data.content.on('readable', () => {\n        let chunk;\n\n        while ((chunk = data.content.read()) !== null) {\n          chunks.push(chunk);\n          chunklen += chunk.length;\n        }\n      });\n      data.content.on('end', () => {\n        data.content = Buffer.concat(chunks, chunklen);\n        data.release();\n        reader();\n      });\n    } else {\n      reader();\n    }\n  };\n\n  parser.on('readable', () => {\n    if (!reading) {\n      reader();\n    }\n  });\n  parser.on('end', () => {\n    ['subject', 'references', 'date', 'to', 'from', 'to', 'cc', 'bcc', 'message-id', 'in-reply-to', 'reply-to'].forEach(key => {\n      if (mail.headers.has(key)) {\n        mail[key.replace(/-([a-z])/g, (m, c) => c.toUpperCase())] = mail.headers.get(key);\n      }\n    });\n\n    if (keepCidLinks) {\n      return callback(null, mail);\n    }\n\n    parser.updateImageLinks((attachment, done) => done(false, 'data:' + attachment.contentType + ';base64,' + attachment.content.toString('base64')), (err, html) => {\n      if (err) {\n        return callback(err);\n      }\n\n      mail.html = html;\n      callback(null, mail);\n    });\n  });\n\n  if (typeof input === 'string') {\n    parser.end(Buffer.from(input));\n  } else if (Buffer.isBuffer(input)) {\n    parser.end(input);\n  } else {\n    input.once('error', err => {\n      input.destroy();\n      parser.destroy();\n      callback(err);\n    }).pipe(parser);\n  }\n\n  return promise;\n};\n\nfunction callbackPromise(resolve, reject) {\n  return function (...args) {\n    let err = args.shift();\n\n    if (err) {\n      reject(err);\n    } else {\n      resolve(...args);\n    }\n  };\n}","map":null,"metadata":{},"sourceType":"script"}